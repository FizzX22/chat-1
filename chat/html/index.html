<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title></title>
  <link href="vendor/latofonts.css" rel="stylesheet">
  <link href="vendor/flexboxgrid.6.3.1.min.css" rel="stylesheet"></link>
  <link href="vendor/animate.3.5.2.min.css" rel="stylesheet"></link>
  <!--<link href="./css/index.css" rel="stylesheet"></link>-->
  <link href="./css/style.css" rel="stylesheet"></link>

  <script src="vendor/vue.2.3.3.min.js" type="text/javascript"></script>
  <script src="./js/config.default.js" type="text/javascript"></script>
  <script src="./js/config.js" type="text/javascript"></script>
  <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
</head>
<body>
  <div id="app"></div>

  <!-- App Template -->
  <script type="text/x-template" id="app_template">
    <div id="app">
      <div class="chat-window" :style="this.style" :class="{ 'fadeOutUp animated': !showWindow, 'hidden': shouldHide }">
        <div class="chat-messages" ref="messages">
          <message v-for="msg in messages"
                   :templates="templates"
                   :multiline="msg.multiline"
                   :args="msg.args"
                   :color="msg.color"
                   :template="msg.template"
                   :template-id="msg.templateId"
                   :key="msg">
          </message>
        </div>
      </div>
      <div class="chat-input" v-show="showInput">
        <span class="prefix">âž¤</span>
        <div>
          <textarea v-model="message"
                    ref="input"
                    type="text"
                    autofocus
                    spellcheck="false"
                    @keyup.esc="hideInput"
                    @keyup="keyUp"
                    @keydown="keyDown"
                    @keypress.enter.prevent="send">
          </textarea>
        </div>
        <suggestions :message="message" :suggestions="suggestions">
        </suggestions>
      </div>
    </div>
  </script>

  <!-- Message Template -->
  <script type="text/x-template" id="message_template">
    <div class="msg" :class="{ multiline }">
      <span v-html="textEscaped"></span>
    </div>
  </script>

  <!-- Suggestions Template -->
  <script type="text/x-template" id="suggestions_template">
    <div class="suggestions-wrap" v-show="currentSuggestions.length > 0">
      <ul class="suggestions">
        <li class="suggestion" v-for="s in currentSuggestions">
          <p>
            <span :class="{ 'disabled': s.disabled }">
              {{s.name}}
            </span>
            <span class="param"
                  v-for="(p, index) in s.params"
                  :class="{ 'disabled': p.disabled }">
              [{{p.name}}]
            </span>
          </p>
          <small class="help">
            <template v-if="!s.disabled">
              {{s.help}}
            </template>
            <template v-for="p in s.params" v-if="!p.disabled">
              {{p.help}}
            </template>
          </small>
        </li>
      </ul>
    </div>
  </script>

  <!-- Scripts -->
  <script type="text/javascript" src="./js/Suggestions.js"></script>
  <script type="text/javascript" src="./js/Message.js"></script>
  <script type="text/javascript" src="./js/App.js"></script>

  <!-- Main Entry -->
  <script type="text/javascript">
  window.post = (url, data) => {
    // Extract callback name from URL path
    const callbackPath = url.split('/').pop(); // gets 'loaded' or 'chatResult'
    
    try {
      const body = JSON.parse(data || '{}');
      
      // Try to send via postMessage (this gets picked up by RegisterNUICallback('message', ...)
      try {
        window.postMessage({
          action: callbackPath,
          data: body
        });
        console.log(`Chat: Sent ${callbackPath} via postMessage`);
        return; // Success
      } catch (e) {
        console.warn(`Chat: postMessage failed: ${e.message}`);
      }
      
      // Fallback: Try fetch to NUI endpoints with resource name guessing
      const resourceNames = ['chat', 'nrp-chat', 'qbx-chat'];  // Try common resource names
      let attempts = 0;
      
      const tryFetch = (index) => {
        if (index >= resourceNames.length) {
          console.error(`Chat: Failed to reach ${callbackPath} callback on any resource`);
          return;
        }
        
        const resourceName = resourceNames[index];
        const endpoint = `https://cfx-nui-${resourceName}/${callbackPath}`;
        attempts++;
        
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 1500);
        
        fetch(endpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: data || '{}',
          signal: controller.signal
        }).then(response => {
          clearTimeout(timeoutId);
          if (response.ok) {
            console.log(`Chat: ${callbackPath} reached on ${resourceName}`);
          } else {
            console.warn(`Chat: ${callbackPath} returned ${response.status}`);
            tryFetch(index + 1); // Try next resource name
          }
        }).catch(err => {
          clearTimeout(timeoutId);
          console.debug(`Chat: Trying next resource (${attempts}): ${err.message}`);
          tryFetch(index + 1); // Try next resource name
        });
      };
      
      // Start trying different resource names
      tryFetch(0);
    } catch (e) {
      console.error('Chat post error:', e);
    }
  }

  const instance = new Vue({
    el: '#app',
    render: h => h(APP),
  });

  window.emulate = (type, detail = {}) => {
    detail.type = type;
    window.dispatchEvent(new CustomEvent('message', {
      detail,
    }));
  };
  </script>

</body>
</html>
